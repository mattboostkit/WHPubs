---
import Layout from '@/layouts/Layout.astro';
import { getPubs, getPubBySlug, getPosts, getMenusForPub, getEvents, getReviews, getOffers, getPubStories, getTeamMembers, getDetailedMenusForPub, getPubFeatures, getPrivacyPolicy, getPubHighlights } from '@/lib/sanity';
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { MapPin, Clock, Phone, UtensilsCrossed, CalendarDays, Image as ImageIcon, ExternalLink, Calendar } from 'lucide-react';
import ImageGallery from '@/components/ImageGallery.astro';
import { PubHeroCarousel } from '@/components/PubHeroCarousel';
import GoogleMapEmbed from '@/components/GoogleMapEmbed';
import SanityPortableText from '@/components/SanityPortableText.jsx';
import BlogCard from '@/components/BlogCard.astro';
import ReviewsSection from '@/components/ReviewsSection.astro';
import OffersSection from '@/components/OffersSection.astro';
import PubMenu from '@/components/PubMenu';
import PubFeatures from '@/components/PubFeatures';
import PubEventsSection from '@/components/PubEventsSection';
import WhyChooseUs from '@/components/WhyChooseUs';
import ChristmasMenu from '@/components/ChristmasMenu';
import PubHeader from '@/components/PubHeader';
import PubQuickInfo from '@/components/PubQuickInfo';
import PubAtmosphere from '@/components/PubAtmosphere';
import PubHighlights from '@/components/PubHighlights';
import PubSocialFeed from '@/components/PubSocialFeed';
import TripAdvisorWidget from '@/components/TripAdvisorWidget';
import PubWarmWelcome from '@/components/PubWarmWelcome';
import PubPerfectFor from '@/components/PubPerfectFor';
import PubSuppliers from '@/components/PubSuppliers';
import PubAmenities from '@/components/PubAmenities';
import PubThingsToDo from '@/components/PubThingsToDo';

// 1. Generate routes for all pubs
// This page will exist in each deployment, but getStaticPaths ensures
// only the relevant pub page is built if TARGET_PUB_SLUG is set during build.
// In dev mode, it builds all pub pages found.
export async function getStaticPaths() {
  const targetPubSlug = import.meta.env.TARGET_PUB_SLUG;
  // Environment variable check handled silently in production
  let pubsToBuild = [];

  if (targetPubSlug) {
    // If building a specific pub site, only fetch and build that pub's page
    // Fetching data for specific pub slug
    let singlePub = await getPubBySlug(targetPubSlug);
    
    // Handle slug migration: the-bull -> the-bull-otford
    if (!singlePub && targetPubSlug === 'the-bull') {
      console.log('Trying alternative slug: the-bull-otford');
      singlePub = await getPubBySlug('the-bull-otford');
    }
    
    // Data fetched for specific pub
    if (singlePub) {
      pubsToBuild.push(singlePub);
    } else {
       // Pub not found for specified slug - build will fail
       throw new Error(`Pub not found for slug: ${targetPubSlug}`);
    }
  } else {
    // If building the main hub site, don't build any pub pages
    // They are hosted on separate domains
    pubsToBuild = [];
  }

  return pubsToBuild.map((pub) => ({
    params: { slug: pub.slug.current },
    props: { pub },
  }));
}

// 2. Get the specific pub data for this page
const { pub } = Astro.props;

// Basic error handling if pub data isn't found for the slug
if (!pub) {
  return Astro.redirect('/404');
}

// 3. Fetch all related data for this pub
const [relatedPosts, pubMenus, pubEvents, pubReviews, pubOffers, pubStories, pubTeam, detailedMenus, pubFeatures, pubHighlights] = await Promise.all([
  getPosts(pub.slug.current),
  getMenusForPub(pub.slug.current),
  getEvents(pub.slug.current),
  getReviews(pub.slug.current),
  getOffers(pub.slug.current),
  getPubStories(pub.slug.current),
  getTeamMembers(pub.slug.current),
  getDetailedMenusForPub(pub.slug.current),
  getPubFeatures(pub.slug.current),
  getPubHighlights(pub.slug.current)
]);

const pageTitle = `${pub.name} - WH Pubs`;
const pageDescription = pub.description || `Learn more about ${pub.name}, one of our fine establishments.`;

// Create structured data for this pub
const pubStructuredData = {
  "@context": "https://schema.org",
  "@type": "Restaurant",
  "name": pub.name,
  "image": pub.heroImage?.asset?.url || pub.image?.asset?.url,
  "url": `https://${pub.externalDomain || 'whpubs.com'}${pub.externalDomain ? '' : '/' + pub.slug.current}`,
  "telephone": pub.contactPhone,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": pub.addressLine1 || pub.location,
    "addressLocality": pub.locationName || pub.location,
    "addressRegion": "Kent",
    "postalCode": pub.postcode,
    "addressCountry": "GB"
  },
  "servesCuisine": "British",
  "priceRange": "££",
  "openingHours": pub.openingHours ? pub.openingHours.split('\n').map(line => line.trim()).filter(Boolean) : [],
  "menu": pub.menuUrl || `https://${pub.externalDomain || 'whpubs.com'}${pub.externalDomain ? '/menu' : '/' + pub.slug.current + '/menu'}`,
  "acceptsReservations": !!pub.reservationsUrl,
  "hasMenu": pubMenus && pubMenus.length > 0,
  "aggregateRating": pubReviews && pubReviews.length > 0 ? {
    "@type": "AggregateRating",
    "ratingValue": pubReviews.reduce((sum, r) => sum + r.rating, 0) / pubReviews.length,
    "reviewCount": pubReviews.length
  } : undefined
};
---

<Layout title={pageTitle} description={pageDescription} pub={pub}> {/* Pass pub data to Layout */}
  <!-- Add pub-specific structured data -->
  <script type="application/ld+json" set:html={JSON.stringify(pubStructuredData)} />
  <main> {/* Remove container/padding from main, apply later */}
    <!-- Hero Section with Carousel -->
    {pub.carouselImages && pub.carouselImages.length > 0 ? (
      <section class="relative h-[50vh] sm:h-[60vh] md:h-[70vh] lg:h-[75vh] w-full">
        <PubHeroCarousel 
          images={pub.carouselImages}
          pubName={pub.name}
          client:load
        />
      </section>
    ) : (
      <!-- Fallback to single hero image if no carousel images -->
      <section class="relative h-[50vh] sm:h-[60vh] md:h-[70vh] lg:h-[75vh] w-full">
        <img
          src={pub.heroImage?.asset?.url || '/images/hero-fallback.jpg'}
          alt={pub.heroImage?.alt || `Hero image for ${pub.name}`}
          class="absolute inset-0 w-full h-full object-cover"
          onerror="this.onerror=null; this.src='/images/hero-fallback.jpg';"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/30 to-transparent"></div>

        <div class="relative z-10 h-full flex flex-col items-center justify-center text-center text-white px-6">
          {pub.heroOverlayText && (
            <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold mb-6 drop-shadow-lg max-w-4xl">
              {pub.heroOverlayText}
            </h1>
          )}
          {pub.heroOverlayButtonText && pub.heroOverlayButtonLink && (
            <a href={pub.heroOverlayButtonLink} target="_blank" rel="noopener noreferrer">
               <Button variant="secondary" size="lg">
                 {pub.heroOverlayButtonText}
               </Button>
            </a>
          )}
        </div>
      </section>
    )}

    {/* Pub Header with Square Logo */}
    <PubHeader 
      pubName={pub.name}
      squareLogo={pub.squareLogo}
      fallbackLogo={pub.logo}
      client:visible
    />

    {/* Quick Info Section - Right after header for immediate information */}
    <section class="py-8 -mt-8 relative z-10">
      <div class="container mx-auto px-4">
        <PubQuickInfo pub={pub} client:visible />
      </div>
    </section>

    {/* Highlights Section - Show what's special this week */}
    <PubHighlights pubName={pub.name} highlightsData={pubHighlights} client:visible />

    {/* Warm Welcome Section - Enhanced */}
    <PubWarmWelcome
      pubName={pub.name}
      pubSlug={pub.slug.current}
      description={pub.description}
      location={pub.location}
      locationName={pub.locationName}
      openingHours={pub.openingHours}
      contactPhone={pub.contactPhone}
      heroImage={{
        url: pub.gallery?.[0]?.asset?.url,
        alt: pub.gallery?.[0]?.alt
      }}
      amenities={pub.amenities}
      client:visible
    />

    {/* Original Welcome Section - Hidden */}
    <section class="py-16 bg-gradient-to-b from-white to-gray-50 hidden">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto text-center">
          <p class="text-secondary uppercase tracking-widest text-sm font-semibold mb-4">Welcome to</p>
          <h1 class="text-5xl font-bold text-primary mb-8">{pub.name.toUpperCase()}</h1>
          
          {/* Custom welcome message based on pub */}
          <div class="space-y-4 mb-10">
            {pub.slug.current === 'the-cricketers-inn' && (
              <>
                <p class="text-lg text-gray-700 leading-relaxed">
                  Step into a piece of Meopham history, where village life meets contemporary comfort. 
                  Overlooking the historic village green, The Cricketers Inn has been the heart of local hospitality for generations.
                </p>
                <p class="text-lg text-gray-700 leading-relaxed">
                  Our characterful pub welcomes you with roaring fires, traditional ales, and a menu that celebrates 
                  the best of British cuisine. Whether you're here for a family lunch, a quiet pint, or a celebration 
                  with friends, you'll find the perfect spot in our cozy bar or sun-trapped garden.
                </p>
              </>
            )}
            {pub.slug.current === 'the-rose-and-crown' && (
              <>
                <p class="text-lg text-gray-700 leading-relaxed">
                  Step into the vibrant heart of Green Street Green, where traditional pub charm meets 
                  modern dining excellence. The Rose and Crown pulses with energy from dawn till dusk, 
                  offering an escape from the everyday.
                </p>
                <p class="text-lg text-gray-700 leading-relaxed">
                  Our extensive outdoor dining areas create the perfect setting for any occasion, while inside, 
                  the bustling atmosphere and warm welcome make every visit memorable. From morning coffee to 
                  evening cocktails, we're here to serve splendid food and drink whenever you need us.
                </p>
              </>
            )}
            {pub.slug.current === 'the-little-brown-jug' && (
              <>
                <p class="text-lg text-gray-700 leading-relaxed">
                  Step into a hidden gem nestled in the heart of the Kent countryside. The Little Brown Jug 
                  enchants with its cozy corners, quirky character, and the kind of genuine warmth that turns 
                  first-time visitors into lifelong friends.
                </p>
                <p class="text-lg text-gray-700 leading-relaxed">
                  Our historic pub embraces its countryside setting, serving scrumptious locally-sourced food 
                  alongside perfectly kept ales. Whether you're walking the North Downs Way or simply seeking 
                  an authentic country pub experience, you'll find your perfect refuge here.
                </p>
              </>
            )}
            {pub.slug.current === 'the-chaser-inn' && (
              <>
                <p class="text-lg text-gray-700 leading-relaxed">
                  Step into the vibrant heart of Shipbourne village, where muddy boots meet craft cocktails 
                  and country character comes with a contemporary twist. The Chaser Inn bursts with life 
                  through every season, from crackling winter fires to sun-drenched summer gardens.
                </p>
                <p class="text-lg text-gray-700 leading-relaxed">
                  We're the kind of pub where dogs are as welcome as their owners, where local farmers 
                  share stories over locally-brewed ales, and where our menu celebrates the bounty of Kent 
                  with dishes that change with the seasons. Come as you are – we've saved you a seat by the fire.
                </p>
              </>
            )}
            {pub.slug.current === 'the-bull' && (
              <>
                <p class="text-lg text-gray-700 leading-relaxed">
                  Step into the heart of Otford village life at The Bull, where traditional British hospitality 
                  has been perfected over centuries. Our historic coaching inn combines timeless charm with 
                  modern comforts, creating the perfect gathering place for every occasion.
                </p>
                <p class="text-lg text-gray-700 leading-relaxed">
                  From our spacious beer garden that hosts summer celebrations to our cozy fireside corners 
                  perfect for winter evenings, The Bull offers a warm welcome to locals and visitors alike. 
                  Our kitchen serves excellent food throughout the day, while our bar showcases the finest 
                  local ales alongside an impressive wine selection.
                </p>
              </>
            )}
          </div>
          
          {/* Location */}
          {pub.location && (
            <div class="flex items-center justify-center text-primary/70 mb-8">
              <MapPin class="w-5 h-5 mr-2" />
              <span class="text-lg">{pub.locationName || pub.location}</span>
            </div>
          )}
          
          {/* Book Table CTA */}
          {pub.reservationsUrl && (
            <a 
              href="/book-a-table-pub"
              onclick={`window.analytics && window.analytics.trackReservation('${pub.name}', 'click_welcome')`}
              class="inline-block"
            >
              <Button variant="default" size="lg">
                Book A Table
              </Button>
            </a>
          )}
        </div>
      </div>
    </section>

    {/* Atmosphere Section - Visual showcase */}
    <PubAtmosphere 
      pubName={pub.name}
      images={pub.gallery?.map(img => ({
        url: img.asset?.url,
        caption: img.alt || 'Interior view',
        time: 'All Day'
      }))}
      client:visible
    />

    {/* Perfect For Section - What we're great for */}
    <PubPerfectFor
      pubName={pub.name}
      pubSlug={pub.slug.current}
      client:visible
    />

    {/* Amenities Section */}
    <PubAmenities
      pubName={pub.name}
      pubSlug={pub.slug.current}
      amenities={pub.amenities}
      client:visible
    />

    {/* Things To Do Section */}
    <PubThingsToDo
      pubName={pub.name}
      pubSlug={pub.slug.current}
      client:visible
    />

    {/* Main Content Area */}
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12 md:py-16">
      <article class="max-w-4xl mx-auto">

      <!-- Description -->
      {pub.description && (
        <div class="prose prose-lg max-w-none text-primary/90 mb-8">
          <p class="text-xl leading-relaxed font-medium">{pub.description}</p>
        </div>
      )}

      <!-- Amenities Pills -->
      {pub.amenities && pub.amenities.length > 0 && (
        <div class="mb-8 flex flex-wrap gap-2 justify-center">
          {pub.amenities.map((amenity) => (
            <Badge 
              variant="secondary" 
              className="px-4 py-2 text-sm font-medium bg-secondary/20 hover:bg-secondary/30 transition-colors"
            >
              {amenity}
            </Badge>
          ))}
        </div>
      )}

      {/* Our Story Section */}
      {pubStories && pubStories.length > 0 && pubStories.some(story => story.featured) && (
        <div class="mb-12">
          {pubStories.filter(story => story.featured).map((story) => (
            <Card class="overflow-hidden hover:shadow-xl transition-all duration-300">
              <CardHeader>
                <CardTitle class="text-2xl flex items-center gap-2">
                  📚 {story.title}
                </CardTitle>
              </CardHeader>
              <CardContent>
                {story.featuredImage?.asset?.url && (
                  <div class="mb-6 rounded-lg overflow-hidden">
                    <img
                      src={story.featuredImage.asset.url}
                      alt={story.featuredImage.alt || story.title}
                      class="w-full h-64 object-cover"
                    />
                    {story.featuredImage.caption && (
                      <p class="text-sm text-muted-foreground mt-2 italic">{story.featuredImage.caption}</p>
                    )}
                  </div>
                )}
                <p class="text-muted-foreground mb-4">{story.summary}</p>
                
                {story.timeline && story.timeline.length > 0 && (
                  <div class="mb-6">
                    <h4 class="font-semibold mb-3">Historical Timeline</h4>
                    <div class="space-y-3">
                      {story.timeline.sort((a, b) => a.year.localeCompare(b.year)).map((event) => (
                        <div class="flex gap-4 items-start">
                          <span class="text-secondary font-bold min-w-[60px]">{event.year}</span>
                          <p class="text-sm">{event.event}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                <a href={`/stories/${story.slug.current}`} class="inline-flex items-center text-primary hover:text-primary/80 font-semibold">
                  Read Full Story →
                </a>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {/* Meet Our Team */}
      {pubTeam && pubTeam.length > 0 && (
        <div class="mb-12">
          <h2 class="text-2xl font-semibold text-primary mb-6 text-center">Meet Our Team</h2>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {pubTeam.slice(0, 6).map((member) => (
              <Card class="overflow-hidden hover:shadow-lg transition-shadow">
                {member.image?.asset?.url && (
                  <div class="aspect-[4/5] overflow-hidden">
                    <img
                      src={member.image.asset.url}
                      alt={member.image.alt || member.name}
                      class="w-full h-full object-cover"
                      loading="lazy"
                    />
                  </div>
                )}
                <CardContent class="p-4">
                  <h4 class="text-lg font-semibold">{member.name}</h4>
                  <p class="text-secondary text-sm mb-2">{member.role}</p>
                  {member.bio && (
                    <p class="text-sm text-muted-foreground">{member.bio}</p>
                  )}
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      )}

      {/* Special Offers Section */}
      {pubOffers && pubOffers.length > 0 && (
        <div class="mb-12 -mx-4 sm:-mx-6 lg:-mx-8">
          <OffersSection 
            offers={pubOffers.slice(0, 6)} 
            title={`Special Offers at ${pub.name}`}
            subtitle="Limited time offers and promotions"
          />
        </div>
      )}

      <!-- Opening Hours -->
      {pub.openingHours && (
        <Card className="mb-8 hover:shadow-xl transition-all duration-300 card-hover">
          <CardHeader>
            <CardTitle className="flex items-center">
              <Clock className="w-5 h-5 mr-2 text-primary/80" />
              Opening Hours
            </CardTitle>
          </CardHeader>
          <CardContent>
            <pre class="whitespace-pre-wrap font-sans text-primary/90">{pub.openingHours}</pre>
          </CardContent>
        </Card>
      )}

      <!-- Food Serving Times -->
      {pub.foodServingTimes && (
        <Card className="mb-8 hover:shadow-xl transition-all duration-300 card-hover bg-gradient-to-br from-white to-secondary/5">
          <CardHeader>
            <CardTitle className="flex items-center">
              <UtensilsCrossed className="w-6 h-6 mr-3 text-primary/80" />
              Food Serving Times
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div class="flex flex-col md:flex-row md:gap-8 text-primary/90">
              {pub.foodServingTimes.split('\n').map((line, idx) => (
                <span key={idx} class="mb-1 md:mb-0 md:mr-4 px-3 py-1 rounded bg-secondary/20 font-medium inline-block">{line}</span>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Contact Info */}
      {(pub.contactPhone || pub.location || pub.addressLine1) && (
        <Card className="mb-8 hover:shadow-xl transition-all duration-300 card-hover bg-gradient-to-br from-white to-primary/5">
          <CardHeader>
            <CardTitle className="flex items-center">
              <Phone className="w-6 h-6 mr-3 text-primary/80" />
              Contact Us
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div class="grid md:grid-cols-2 gap-4">
              {pub.contactPhone && (
                <div class="flex items-center">
                  <Phone class="w-5 h-5 mr-3 text-primary/60" />
                  <div>
                    <p class="text-sm text-primary/70">Call us</p>
                    <a href={`tel:${pub.contactPhone.replace(/\s/g, '')}`} class="text-lg font-medium text-primary hover:text-secondary transition-colors no-underline">
                      {pub.contactPhone}
                    </a>
                  </div>
                </div>
              )}
              {(pub.location || pub.addressLine1) && (
                <div class="flex items-start">
                  <MapPin class="w-5 h-5 mr-3 text-primary/60 mt-1" />
                  <div>
                    <p class="text-sm text-primary/70">Find us</p>
                    <p class="font-medium text-primary">{pub.location}</p>
                    {pub.addressLine1 && <p class="text-sm text-primary/80">{pub.addressLine1}</p>}
                    {pub.postcode && <p class="text-sm text-primary/80">{pub.postcode}</p>}
                  </div>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Google Map */}
      {pub.googleMapEmbed?.iframe && (
        <Card className="mb-12 hover:shadow-xl transition-all duration-300 card-hover overflow-hidden">
          <CardHeader>
            <CardTitle className="flex items-center">
              <MapPin className="w-5 h-5 mr-2 text-primary/80" />
              Find Us
            </CardTitle>
          </CardHeader>
          <CardContent className="p-0">
            <GoogleMapEmbed 
              iframe={pub.googleMapEmbed.iframe} 
              className="w-full"
              client:load
            />
          </CardContent>
        </Card>
      )}

      {/* Discover What's On Tap Section */}
      {pubFeatures && (
        <div class="mb-12 -mx-4 sm:-mx-6 lg:-mx-8">
          <PubFeatures features={pubFeatures} client:load />
        </div>
      )}

      <!-- Image Gallery -->
      {pub.gallery && pub.gallery.length > 0 && (
        <div class="mb-12">
          <h2 class="text-3xl font-semibold text-primary mb-6 flex items-center">
             <ImageIcon class="w-6 h-6 mr-3 text-primary/80" /> Gallery
          </h2>
          <div class="mt-6">
            <ImageGallery 
              images={pub.gallery} 
              showCategories={true}
              columns={3}
              className="gallery-enhanced"
            />
          </div>
        </div>
      )}

      {/* Christmas Menu Section */}
      <div class="mb-12 -mx-4 sm:-mx-6 lg:-mx-8">
        <ChristmasMenu 
          christmasMenu={pub.christmasMenu}
          pubName={pub.name}
          bookingUrl={pub.reservationsUrl || '/book-a-table-pub'}
          client:load
        />
      </div>

      {/* Regular Menus Section */}
      {(detailedMenus && detailedMenus.length > 0) && (
        <div class="mb-12 -mx-4 sm:-mx-6 lg:-mx-8">
          <PubMenu menus={detailedMenus} client:load />
        </div>
      )}

      {/* Why Choose Us Section - Always show with defaults if not provided */}
      <div class="mb-12 -mx-4 sm:-mx-6 lg:-mx-8">
        <WhyChooseUs 
          reasons={pub.whyChooseUs || {
            reason1: { 
              title: "EXCEPTIONAL FOOD", 
              description: "Fresh, locally-sourced ingredients prepared by our talented chefs" 
            },
            reason2: { 
              title: "PERFECT ATMOSPHERE", 
              description: "Cozy interiors with roaring fires and beautiful gardens for sunny days" 
            },
            reason3: { 
              title: "MEMORABLE EVENTS", 
              description: "From live music to quiz nights, there's always something happening" 
            }
          }}
          backgroundImage={pub.whyChooseUs?.backgroundImage?.asset?.url}
          client:load
        />
      </div>

      {/* Events Section */}
      <PubEventsSection events={pubEvents} pubName={pub.name} client:load />

      {/* Suppliers Section - Compact for pub pages */}
      <div class="mb-12 -mx-4 sm:-mx-6 lg:-mx-8">
        <PubSuppliers 
          pubName={pub.name} 
          pubSlug={pub.slug.current} 
          compact={true}
          client:visible
        />
      </div>

      {/* Social Feed Section */}
      <PubSocialFeed 
        pubName={pub.name}
        instagramHandle={pub.instagramUrl ? `@${pub.instagramUrl.split('/').pop()}` : '@whpubs'}
        facebookUrl={pub.facebookUrl}
        client:visible
      />

      {/* TripAdvisor Reviews Widget */}
      <div class="mb-12 -mx-4 sm:-mx-6 lg:-mx-8">
        <TripAdvisorWidget 
          pubSlug={pub.slug.current}
          pubName={pub.name}
          client:visible
        />
      </div>

      {/* Customer Reviews Section */}
      {pubReviews && pubReviews.length > 0 && (
        <div class="mb-12 -mx-4 sm:-mx-6 lg:-mx-8">
          <ReviewsSection 
            reviews={pubReviews.slice(0, 6)} 
            title={`More Reviews for ${pub.name}`}
            subtitle="See what our customers are saying"
          />
        </div>
      )}

      {/* Latest News Section */}
      {(relatedPosts && relatedPosts.length > 0) ? (
        <div class="mb-12">
          <h2 class="text-3xl font-semibold text-primary mb-6">Latest News from {pub.name}</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {relatedPosts.slice(0, 3).map((post) => (
              <BlogCard post={post} />
            ))}
          </div>
          {relatedPosts.length > 3 && (
            <div class="text-center mt-8">
              <a href="/blog" class="no-underline inline-block">
                <Button variant="outline">View All News</Button>
              </a>
            </div>
          )}
        </div>
      ) : (
        <div class="mb-12 p-8 bg-gray-50 rounded-xl text-center">
          <h3 class="text-xl font-semibold text-primary mb-2">Stay Tuned</h3>
          <p class="text-primary/70">News and updates from {pub.name} coming soon!</p>
        </div>
      )}

      <!-- External Website Link - Only show if not on pub's own site -->
      {pub.url && !pub.externalDomain && (
        <div class="mt-12 text-center">
          <a href={pub.url} target="_blank" rel="noopener noreferrer" class="no-underline">
            <Button variant="outline" size="lg" class="border-primary text-primary hover:bg-primary hover:text-secondary">
              Visit {pub.name}'s Official Website
            </Button>
          </a>
        </div>
      )}


    </article>
  </main>
</Layout>