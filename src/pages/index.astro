---
import Layout from '../layouts/Layout.astro';
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { MapPin, Clock, Phone, Music, ChefHat, Beer, ExternalLink, Star, Utensils } from 'lucide-react';
import { getPosts, getPubs, getHomepageData, getDevelopmentKitchen } from '../lib/sanity';
import { HeroCarousel } from '@/components/HeroCarousel';
// This page always renders the main hub content.

// Fetch data needed for the hub page
const posts = await getPosts(); // Fetches general posts (no pub associated)
const pubs = await getPubs(); // Fetches all pubs
const homepageData = await getHomepageData(); // Fetch homepage content
let developmentKitchen = null;
try {
  developmentKitchen = await getDevelopmentKitchen(); // Fetch development kitchen data
} catch (error) {
  // Development Kitchen data not available yet
}

// Separate featured pubs from regular pubs
const featuredPubs = pubs.filter(pub => pub.featured);
const regularPubs = pubs.filter(pub => !pub.featured);

// Format the date for display
const formatDate = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-GB', {
    day: 'numeric', month: 'long', year: 'numeric'
  });
};
---

{/* Use homepage title from Sanity if available */}
<Layout title={homepageData?.title || "WH Pubs - Traditional British Pubs"}>
  <main>
    {/* Hero Section with Carousel */}
    <HeroCarousel 
      images={homepageData?.heroImages || (homepageData?.heroImage ? [homepageData.heroImage] : [])}
      heroTitle={homepageData?.heroTitle || 'Traditional British Hospitality in the South East of England'}
      heroSubtitle={homepageData?.heroSubtitle || 'Traditional British Hospitality...'}
      heroButton1Text={homepageData?.heroButton1Text}
      heroButton1Link={homepageData?.heroButton1Link}
      heroButton2Text={homepageData?.heroButton2Text}
      heroButton2Link={homepageData?.heroButton2Link}
      client:load
    />

    {/* Featured Pubs Section */}
    {featuredPubs.length > 0 && (
      <section class="py-20 bg-gradient-to-b from-secondary/20 to-secondary/5">
        <div class="container mx-auto px-4">
          <div class="text-center mb-12">
            <Badge variant="outline" className="mb-4">Featured</Badge>
            <h2 class="text-4xl font-bold text-primary">Signature Destinations</h2>
            <p class="text-lg text-muted-foreground mt-4 max-w-2xl mx-auto">
              Experience the finest in traditional British hospitality at our flagship establishments
            </p>
          </div>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            {featuredPubs.map(pub => (
              <Card key={pub.slug.current} className="overflow-hidden hover:shadow-xl transition-shadow">
                <div class="relative h-64 overflow-hidden">
                  <img
                    src={pub.heroImage?.asset?.url || pub.image?.asset?.url || '/images/hero-fallback.jpg'}
                    alt={pub.heroImage?.alt || pub.image?.alt || `Image of ${pub.name}`}
                    class="w-full h-full object-cover transition-transform hover:scale-105"
                    onerror="this.onerror=null; this.src='/images/hero-fallback.jpg';"
                  />
                  <div class="absolute top-4 right-4">
                    <Badge className="bg-primary/90 text-secondary">
                      <Star className="w-3 h-3 mr-1" />
                      Featured
                    </Badge>
                  </div>
                </div>
                <CardHeader>
                  <CardTitle className="text-2xl">{pub.name}</CardTitle>
                  <div class="flex items-center text-muted-foreground">
                    <MapPin className="w-4 h-4 mr-2" />
                    <span>{pub.locationName || pub.location}</span>
                  </div>
                </CardHeader>
                <CardContent>
                  <CardDescription className="mb-4">{pub.description}</CardDescription>
                  {pub.amenities && pub.amenities.length > 0 && (
                    <div class="flex flex-wrap gap-2 mb-4">
                      {pub.amenities.slice(0, 3).map(amenity => (
                        <Badge key={amenity} variant="secondary" className="text-xs">
                          {amenity}
                        </Badge>
                      ))}
                    </div>
                  )}
                  <div class="flex gap-2">
                    {pub.externalDomain ? (
                      <a href={`https://${pub.externalDomain}`} target="_blank" rel="noopener noreferrer" class="flex-1">
                        <Button className="w-full bg-primary hover:bg-primary/90">
                          Visit Website
                          <ExternalLink className="w-4 h-4 ml-2" />
                        </Button>
                      </a>
                    ) : (
                      <a href={`/${pub.slug.current}`} class="flex-1">
                        <Button className="w-full bg-primary hover:bg-primary/90">
                          View Details
                        </Button>
                      </a>
                    )}
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      </section>
    )}

    {/* All Pubs Section */}
    <section id="establishments" class="py-20 bg-background">
      <div class="container mx-auto px-4">
        <h2 class="text-4xl font-bold text-center mb-12 text-primary">
          {featuredPubs.length > 0 ? 'All Our Establishments' : 'Our Establishments'}
        </h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
          {regularPubs.length > 0 ? (
            regularPubs.map(pub => (
              <Card key={pub.slug.current} className="overflow-hidden hover:shadow-lg transition-shadow">
                <div class="relative h-48 overflow-hidden">
                  <img
                    src={pub.image?.asset?.url || '/images/hero-fallback.jpg'}
                    alt={pub.image?.alt || `Image of ${pub.name}`}
                    class="w-full h-full object-cover transition-transform hover:scale-105"
                    onerror="this.onerror=null; this.src='/images/hero-fallback.jpg';"
                  />
                </div>
                <CardHeader>
                  <CardTitle className="text-lg">{pub.name}</CardTitle>
                  <div class="flex items-center text-sm text-muted-foreground">
                    <MapPin className="w-3 h-3 mr-1" />
                    <span>{pub.locationName || pub.location}</span>
                  </div>
                </CardHeader>
                <CardContent>
                  <CardDescription className="text-sm mb-4 line-clamp-2">{pub.description}</CardDescription>
                  {pub.externalDomain ? (
                    <a href={`https://${pub.externalDomain}`} target="_blank" rel="noopener noreferrer" class="block">
                      <Button variant="outline" size="sm" className="w-full">
                        Visit Website
                        <ExternalLink className="w-3 h-3 ml-2" />
                      </Button>
                    </a>
                  ) : (
                    <a href={`/${pub.slug.current}`} class="block">
                      <Button variant="outline" size="sm" className="w-full">
                        View Details
                      </Button>
                    </a>
                  )}
                </CardContent>
              </Card>
            ))
          ) : (
            <p class="col-span-full text-center text-muted-foreground">
              {featuredPubs.length > 0 ? 'All pubs are currently featured above.' : 'No establishments found.'}
            </p>
          )}
        </div>
      </div>
    </section>

    {/* Development Kitchen Section */}
    {developmentKitchen && (
      <section class="py-20 bg-gradient-to-r from-primary to-primary/95 text-secondary">
        <div class="container mx-auto px-4">
          <div class="grid md:grid-cols-2 gap-12 items-center">
            <div>
              <Badge variant="secondary" className="mb-4">Innovation Hub</Badge>
              <h2 class="text-4xl font-bold mb-6 text-secondary">{developmentKitchen.title}</h2>
              <p class="text-lg text-secondary/90 mb-8">
                Where culinary innovation meets tradition. Our Development Kitchen is the creative heart of WH Pubs, 
                crafting seasonal menus that celebrate the finest local ingredients.
              </p>
              <div class="grid grid-cols-2 gap-6 mb-8">
                <div>
                  <h3 class="text-xl font-bold mb-2 text-secondary flex items-center">
                    <Utensils className="w-5 h-5 mr-2" />
                    Menu Innovation
                  </h3>
                  <p class="text-secondary/80 text-sm">Creating seasonal dishes that delight</p>
                </div>
                <div>
                  <h3 class="text-xl font-bold mb-2 text-secondary flex items-center">
                    <MapPin className="w-5 h-5 mr-2" />
                    Local Sourcing
                  </h3>
                  <p class="text-secondary/80 text-sm">Supporting regional producers</p>
                </div>
              </div>
              <a href="/development-kitchen">
                <Button size="lg" variant="secondary" className="bg-secondary text-primary hover:bg-secondary/90">
                  Explore Our Kitchen
                </Button>
              </a>
            </div>
            <div class="relative">
              {developmentKitchen.heroImage && (
                <img
                  src={developmentKitchen.heroImage.asset.url}
                  alt={developmentKitchen.heroImage.alt}
                  class="rounded-lg shadow-2xl w-full"
                />
              )}
              {developmentKitchen.chefProfile && (
                <div class="absolute -bottom-6 -left-6 bg-white rounded-lg shadow-lg p-4 max-w-xs">
                  <p class="text-sm font-semibold text-primary">{developmentKitchen.chefProfile.name}</p>
                  <p class="text-xs text-muted-foreground">{developmentKitchen.chefProfile.title}</p>
                </div>
              )}
            </div>
          </div>
        </div>
      </section>
    )}

    {/* Features Section */}
    <section class="py-16 bg-muted/50">
      <div class="container mx-auto px-4">
        <div class="grid md:grid-cols-3 gap-8">
          <div class="text-center">
            <div class="bg-primary/10 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
              <ChefHat class="w-12 h-12 text-primary" />
            </div>
            <h3 class="text-xl font-bold mb-2 text-primary">Seasonal Menus</h3>
            <p class="text-muted-foreground">Fresh, locally-sourced ingredients prepared by our skilled chefs.</p>
          </div>
          <div class="text-center">
            <div class="bg-primary/10 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
              <Beer class="w-12 h-12 text-primary" />
            </div>
            <h3 class="text-xl font-bold mb-2 text-primary">Local Ales</h3>
            <p class="text-muted-foreground">Carefully selected craft beers and traditional cask ales.</p>
          </div>
          <div class="text-center">
            <div class="bg-primary/10 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
              <Music class="w-12 h-12 text-primary" />
            </div>
            <h3 class="text-xl font-bold mb-2 text-primary">Special Events</h3>
            <p class="text-muted-foreground">Regular events, live music, and themed dining experiences.</p>
          </div>
        </div>
      </div>
    </section>

    {/* Latest News Section (Shows only general posts) */}
    <section class="py-20 bg-white text-primary">
      <div class="container mx-auto px-4">
        <h2 class="text-4xl font-bold text-center mb-12">Latest News</h2>
        <div class="grid md:grid-cols-3 gap-8">
          {posts && posts.length > 0 ? (
             posts.slice(0, 3).map(post => (
              <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <img
                  src={post.mainImage?.asset?.url || '/images/blog-fallback.jpg'}
                  alt={post.imageAlt || 'Blog post image'}
                  class="w-full h-48 object-cover"
                  onerror="this.onerror=null; this.src='https:///images/blog-fallback.jpg';"
                />
                <div class="p-6">
                  <p class="text-primary/60 text-sm mb-2">{formatDate(post.publishedAt)}</p>
                  <h3 class="text-xl font-bold mb-2 text-[#B79C64]">{post.title}</h3>
                  <p class="text-primary/70 mb-4">{post.excerpt}</p>
                  <a href={`/blog/${post.slug.current}`} class="inline-block">
                    <Button variant="link" class="p-0 text-primary hover:text-primary/80">Read More â†’</Button>
                  </a>
                </div>
              </div>
            ))
          ) : (
             <p class="col-span-full text-center text-primary/70">No general news posts found.</p>
          )}
        </div>
      </div>
    </section>

    {/* Newsletter Section */}
    <section class="bg-primary py-16">
      <div class="container mx-auto px-4 text-center">
        <h2 class="text-3xl font-bold text-secondary mb-4">Stay Updated</h2>
        <p class="text-secondary/80 mb-8">Subscribe to our newsletter for the latest news and special offers.</p>
        <div class="max-w-md mx-auto flex gap-4">
          <input
            type="email"
            placeholder="Enter your email"
            class="flex-1 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary bg-secondary/10 text-secondary placeholder:text-secondary/50 border border-secondary/20"
          />
          <Button variant="secondary" class="bg-[#B79C64] text-primary hover:bg-[#B79C64]/90">Subscribe</Button>
        </div>
      </div>
    </section>
  </main>
</Layout>