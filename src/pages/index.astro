---
import Layout from '../layouts/Layout.astro';
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { MapPin, Clock, Phone, Music, ChefHat, Beer, ExternalLink, Star, Utensils, Dog, TreePine, Wheat, CalendarDays, Gift } from 'lucide-react';
import { getPubs, getHomepageData, getDevelopmentKitchen, getCustomerReviews, getOffers, getEvents } from '../lib/sanity';
import { HeroCarousel } from '@/components/HeroCarousel';
import { getPubUrl, isExternalUrl } from '@/lib/pub-urls';
import OffersSection from '@/components/OffersSection.astro';
import PubCardHover from '@/components/PubCardHover';
import EventsCarousel from '@/components/EventsCarousel';
import PubsCarousel from '@/components/PubsCarousel';
import LiveResBookingWidget from '@/components/LiveResBookingWidget';
import WhyChooseUs from '@/components/WhyChooseUs';
import HomepageStats from '@/components/HomepageStats';
import ServicesGrid from '@/components/ServicesGrid';
import TestimonialsCarousel from '@/components/TestimonialsCarousel';
import CustomerReviews from '@/components/CustomerReviews';
import EnhancedHero from '@/components/EnhancedHero';
import FeaturedDishes from '@/components/FeaturedDishes';
import WhatsOn from '@/components/WhatsOn';
import LocationFinder from '@/components/LocationFinder';
import AmenityBadges from '@/components/AmenityBadges';

// This page always renders the main hub content.

// Fetch data needed for the hub page
const pubs = await getPubs(); // Fetches all pubs
console.log('All pubs data:', pubs.map(p => ({ name: p.name, slug: p.slug.current, hasImage: !!p.image }))); // Debug log
const homepageData = await getHomepageData(); // Fetch homepage content
let developmentKitchen = null;
try {
  developmentKitchen = await getDevelopmentKitchen(); // Fetch development kitchen data
} catch (error) {
  // Development Kitchen data not available yet
}

// Fetch customer reviews for the testimonials carousel
const customerReviews = await getCustomerReviews(null, 10); // Get top 10 featured reviews

// Fetch active offers for the homepage
const activeOffers = await getOffers(null, true); // Get active general offers

// Fetch upcoming events for the homepage
const upcomingEvents = await getEvents(); // Get all upcoming events

// All pubs are equal - no featured pubs
const allPubs = pubs;


---

{/* Use homepage title from Sanity if available */}
<Layout title={homepageData?.title || "WH Pubs - Traditional British Pubs"}>
  <main>
    {/* Hero Section with Carousel */}
    <HeroCarousel 
      images={homepageData?.heroImages || (homepageData?.heroImage ? [homepageData.heroImage] : [])}
      heroTitle={homepageData?.heroTitle || 'ESCAPE TO EXTRAORDINARY'}
      heroSubtitle={homepageData?.heroSubtitle || 'Five distinctive pubs. Countless memories waiting to be made.'}
      heroButton1Text={homepageData?.heroButton1Text || 'Book a Table'}
      heroButton1Link={homepageData?.heroButton1Link || '/book-table'}
      heroButton2Text={homepageData?.heroButton2Text || 'View Our Pubs'}
      heroButton2Link={homepageData?.heroButton2Link || '/our-pubs'}
      client:load
    />

    {/* Special Offers Section */}
    {activeOffers && activeOffers.length > 0 && (
      <OffersSection offers={activeOffers.slice(0, 6)} />
    )}

    {/* Welcome to WH Pubs Section */}
    <section class="py-20 bg-gradient-to-b from-white to-gray-50">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          <div class="text-center mb-12">
            <span class="text-secondary text-sm font-semibold uppercase tracking-wider">Welcome to WH Pubs</span>
            <h2 class="header-section">Step into Timeless Tradition</h2>
          </div>
          
          <div class="grid lg:grid-cols-2 gap-12 items-center mb-12">
            {/* Text Content */}
            <div class="space-y-4">
              <p class="text-lg text-gray-700 leading-relaxed">
                Step into warm, welcoming pubs where crackling fires meet contemporary comfort, 
                sun-drenched gardens host perfect afternoons, and our kitchens serve honest British fare with a modern twist.
              </p>
              <p class="text-lg text-gray-700 leading-relaxed">
                We have carefully created relaxed and beautiful environments where people can come for any occasion, whether it be a bite to eat, 
                a drink with friends, or a big birthday celebration. It's very important to us that our customers have a highly enjoyable 
                experience whilst they're with us, and we hope that over time they become frequent visitors, recommending us to others.
              </p>
              <div class="pt-6">
                <a href="/book-table" class="inline-block">
                  <Button size="lg" variant="default">
                    Book a Table
                  </Button>
                </a>
              </div>
            </div>
            
            {/* Images Grid */}
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-4">
                <img 
                  src={homepageData?.welcomeImage1?.asset?.url || "/images/pub-interior-cozy.jpg"} 
                  alt={homepageData?.welcomeImage1?.alt || "Cozy pub interior with fireplace"} 
                  class="rounded-lg shadow-lg w-full h-48 object-cover"
                  onerror="this.onerror=null; this.src='/images/pub-fallback.jpg';"
                />
                <img 
                  src={homepageData?.welcomeImage2?.asset?.url || "/images/pub-garden-summer.jpg"} 
                  alt={homepageData?.welcomeImage2?.alt || "Sun-drenched pub garden"} 
                  class="rounded-lg shadow-lg w-full h-64 object-cover"
                  onerror="this.onerror=null; this.src='/images/pub-fallback.jpg';"
                />
              </div>
              <div class="space-y-4 pt-8">
                <img 
                  src={homepageData?.welcomeImage3?.asset?.url || "/images/british-food-plate.jpg"} 
                  alt={homepageData?.welcomeImage3?.alt || "Traditional British cuisine"} 
                  class="rounded-lg shadow-lg w-full h-64 object-cover"
                  onerror="this.onerror=null; this.src='/images/food-fallback.jpg';"
                />
                <img 
                  src={homepageData?.welcomeImage4?.asset?.url || "/images/local-ales-bar.jpg"} 
                  alt={homepageData?.welcomeImage4?.alt || "Selection of local ales at the bar"} 
                  class="rounded-lg shadow-lg w-full h-48 object-cover"
                  onerror="this.onerror=null; this.src='/images/pub-fallback.jpg';"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    {/* Featured Dishes Showcase */}
    <FeaturedDishes 
      client:visible 
      signatureDishes={homepageData?.signatureDishes}
    />

    {/* Services Grid - What We Offer */}
    <ServicesGrid client:visible />

    {/* Events Carousel Section */}
    {upcomingEvents && upcomingEvents.length > 0 && (
      <EventsCarousel 
        events={upcomingEvents.slice(0, 9)} 
        client:load 
      />
    )}

    {/* Customer Reviews Section */}
    {customerReviews && customerReviews.length > 0 && (
      <CustomerReviews reviews={customerReviews} client:visible />
    )}

    {/* All Pubs Grid Section */}
    <section id="pubs" class="py-20 bg-white">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <p class="text-secondary uppercase tracking-widest text-sm font-semibold mb-4">Explore</p>
          <h2 class="header-section">Our Pubs</h2>
        </div>
        <div class="space-y-6">
          {allPubs.length > 0 ? (
            <>
              {/* First row - 3 pubs */}
              <div class="grid md:grid-cols-3 gap-6 sm:gap-8">
                {allPubs.slice(0, 3).map(pub => (
                  <PubCardHover pub={pub} client:load>
                    <Card key={pub.slug.current} className="border-0 shadow-none mb-6 md:mb-0">
                <CardHeader>
                  <CardTitle className="text-lg">{pub.name}</CardTitle>
                  <div class="flex items-center text-sm text-muted-foreground">
                    <MapPin className="w-3 h-3 mr-1" />
                    <span>{pub.locationName || pub.location}</span>
                  </div>
                </CardHeader>
                <CardContent>
                  <CardDescription className="text-sm mb-4 line-clamp-2">{pub.description}</CardDescription>
                  
                  {/* Amenity badges */}
                  <div class="mb-4">
                    <AmenityBadges amenities={pub.amenities} maxDisplay={4} client:load />
                  </div>
                  
                  {(() => {
                    const pubUrl = getPubUrl(pub);
                    const isExt = isExternalUrl(pubUrl);
                    return (
                      <div class="grid grid-cols-2 gap-3">
                        <a href={pubUrl} target={isExt ? "_blank" : undefined} rel={isExt ? "noopener noreferrer" : undefined} class="block">
                          <Button variant="default" size="sm" className="w-full">
                            Visit Pub Site
                          </Button>
                        </a>
                        <a href="/book-table" class="block">
                          <Button variant="secondary" size="sm" className="w-full">
                            Book a Table
                          </Button>
                        </a>
                      </div>
                    );
                  })()}
                </CardContent>
                    </Card>
                  </PubCardHover>
                ))}
              </div>
              
              {/* Second row - up to 3 pubs */}
              {allPubs.length > 3 && (
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8">
                  {allPubs.slice(3, 6).map(pub => (
                    <PubCardHover pub={pub} client:load>
                      <Card key={pub.slug.current} className="border-0 shadow-none">
                      <CardHeader>
                        <CardTitle className="text-lg">{pub.name}</CardTitle>
                        <div class="flex items-center text-sm text-muted-foreground">
                          <MapPin className="w-3 h-3 mr-1" />
                          <span>{pub.locationName || pub.location}</span>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <CardDescription className="text-sm mb-4 line-clamp-2">{pub.description}</CardDescription>
                        
                        {/* Amenity badges */}
                        <div class="mb-4">
                          <AmenityBadges amenities={pub.amenities} maxDisplay={4} client:load />
                        </div>
                        
                        {
                          (() => {
                            const pubUrl = getPubUrl(pub);
                            const isExt = isExternalUrl(pubUrl);
                            return (
                              <div class="grid grid-cols-2 gap-3">
                                <a href={pubUrl} target={isExt ? "_blank" : undefined} rel={isExt ? "noopener noreferrer" : undefined} class="block">
                                  <Button variant="default" size="sm" className="w-full">
                                    Visit Pub Site
                                  </Button>
                                </a>
                                <a href="/book-table" class="block">
                                  <Button variant="secondary" size="sm" className="w-full">
                                    Book a Table
                                  </Button>
                                </a>
                              </div>
                            );
                          })()
                        }
                      </CardContent>
                      </Card>
                    </PubCardHover>
                  ))}
                </div>
              )}
            </>
          ) : (
            <p class="text-center text-muted-foreground">
              No pubs found.
            </p>
          )}
        </div>
      </div>
    </section>

    {/* Development Kitchen Section */}
    {developmentKitchen && (
      <section class="relative py-20 bg-gradient-to-r from-primary to-primary/95 text-secondary overflow-hidden border-t-4 border-secondary">
        <div class="absolute inset-0 bg-[url('/images/pattern.svg')] opacity-5"></div>
        <div class="container mx-auto px-4 relative z-10">
          <div class="grid md:grid-cols-2 gap-12 items-center">
            <div>
              <Badge variant="secondary" className="mb-4">Innovation Hub</Badge>
              <h2 class="header-section header-secondary">Development Kitchen</h2>
              <p class="text-lg text-secondary/90 mb-8">
                Where culinary innovation meets tradition. Our Development Kitchen is the creative heart of WH Pubs, 
                crafting seasonal menus that celebrate the finest local ingredients.
              </p>
              <div class="grid grid-cols-2 gap-6 mb-8">
                <div>
                  <h3 class="header-content header-secondary flex items-center">
                    <Utensils className="w-5 h-5 mr-2" />
                    Menu Innovation
                  </h3>
                  <p class="text-secondary/80 text-sm">Creating seasonal dishes that delight</p>
                </div>
                <div>
                  <h3 class="header-content header-secondary flex items-center">
                    <MapPin className="w-5 h-5 mr-2" />
                    Local Sourcing
                  </h3>
                  <p class="text-secondary/80 text-sm">Supporting regional producers</p>
                </div>
              </div>
              <a href="/development-kitchen">
                <Button size="lg" variant="secondary">
                  Explore Our Kitchen
                </Button>
              </a>
            </div>
            <div class="relative">
              {developmentKitchen.heroImage && (
                <img
                  src={developmentKitchen.heroImage.asset.url}
                  alt={developmentKitchen.heroImage.alt}
                  class="rounded-lg shadow-2xl w-full"
                />
              )}
            </div>
          </div>
        </div>
      </section>
    )}


    {/* Why Choose Us Section with Hover Effects */}
    <WhyChooseUs 
      reasons={homepageData?.whyChooseUs}
      backgroundImage={homepageData?.whyChooseUs?.backgroundImage?.asset?.url}
      client:load
    />






    {/* Newsletter Section */}
    <section class="bg-gradient-to-b from-primary to-primary/90 py-20 relative overflow-hidden">
      <div class="absolute inset-0 bg-[url('/images/pattern.svg')] opacity-5"></div>
      <div class="container mx-auto px-4 text-center relative z-10">
        <div class="max-w-2xl mx-auto">
          <Badge variant="secondary" className="mb-4">Newsletter</Badge>
          <h2 class="header-section header-secondary">Stay Updated</h2>
          <p class="text-secondary/90 mb-8 text-lg">Subscribe to our newsletter for the latest news, special offers, and exclusive events at WH Pubs.</p>
        <form 
          name="newsletter" 
          method="POST" 
          action="/thank-you"
          data-netlify="true" 
          data-netlify-honeypot="bot-field"
          class="max-w-md mx-auto flex gap-4"
        >
          <input type="hidden" name="form-name" value="newsletter" />
          <p class="hidden">
            <label>Don't fill this out if you're human: <input name="bot-field" /></label>
          </p>
          <label for="email-input" class="sr-only">Email address</label>
          <input
            id="email-input"
            type="email"
            name="email"
            placeholder="Enter your email"
            required
            aria-label="Email address for newsletter"
            class="flex-1 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary bg-secondary/10 text-secondary placeholder:text-secondary/50 border border-secondary/20"
          />
          <Button type="submit" variant="secondary">Subscribe</Button>
        </form>
        </div>
      </div>
    </section>

  </main>
</Layout>