---
// src/pages/book-a-table-pub.astro
// Pub-specific booking page that uses TARGET_PUB_SLUG to show the correct LiveRes widget
import Layout from '@/layouts/Layout.astro';
import PageHero from '@/components/PageHero.astro';
import { getPubBySlug } from '@/lib/sanity';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Phone, MapPin, Clock, Calendar, Users, ChefHat, Star } from 'lucide-react';
import LiveResBookingWidget from '@/components/LiveResBookingWidget';
import EnhancedBookingWidget from '@/components/EnhancedBookingWidget';

// Get the target pub slug from environment variable
const targetPubSlug = import.meta.env.TARGET_PUB_SLUG;

// Fetch the specific pub's data
const pub = targetPubSlug ? await getPubBySlug(targetPubSlug) : null;

if (!pub) {
  return Astro.redirect('/');
}

// Use the LiveRes site ID from Sanity, with fallback to URL extraction
let siteId = pub.liveResSiteId;
if (!siteId && pub.liveResWidgetUrl) {
  const urlParams = new URLSearchParams(pub.liveResWidgetUrl.split('?')[1]);
  siteId = urlParams.get('siteId');
}

const pageTitle = `Book a Table - ${pub.name}`;
const pageDescription = `Reserve your table at ${pub.name}, ${pub.locationName || pub.location}. Book online for instant confirmation.`;
---

<Layout title={pageTitle} description={pageDescription} pub={pub}>
  <PageHero 
    title={`Book a Table at ${pub.name}`}
    subtitle={`Reserve your perfect dining experience in ${pub.locationName || pub.location}`}
    image={pub.bookingPageHeroImage || pub.heroImage}
    fallbackImage="/images/book-table-hero.jpg"
  />
  
  <main>
    {/* Main Booking Section */}
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <div class="max-w-7xl mx-auto">
          {/* Intro Text */}
          <div class="text-center mb-12">
            <p class="text-lg text-primary/70 max-w-3xl mx-auto">
              Whether you're planning a romantic dinner, family gathering, or catching up with friends, 
              we're delighted to welcome you to {pub.name}. Book your table below for instant confirmation.
            </p>
          </div>

          {/* Enhanced Booking Widget */}
          <EnhancedBookingWidget pub={pub} client:load />

        </div>
      </div>
    </section>
  </main>
</Layout>