---
import Layout from '../layouts/Layout.astro';
import PageHero from '../components/PageHero.astro';
import { getPubs, getPageSettings } from '../lib/sanity';
import { Button } from '../components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import { Badge } from '../components/ui/badge';
import { MapPin, Clock, Phone, ExternalLink, Calendar, Utensils } from 'lucide-react';

// Fetch all pubs for the booking page
const pubs = await getPubs();

// Fetch page settings for hero image
const pageSettings = await getPageSettings();
const pageHero = pageSettings?.bookATable || {};

const title = "Book a Table - WH Pubs";
const description = "Make a reservation at one of our traditional British pubs across South East England. Easy online booking available.";
---

<Layout title={title} description={description}>
  <PageHero
    title={pageHero.heroTitle || "Make a Reservation"}
    subtitle={pageHero.heroSubtitle || "Choose your preferred pub and book your table"}
    image={pageHero.heroImage || {
      asset: { url: '/images/hero-fallback.jpg' },
      alt: 'Book a table at WH Pubs'
    }}
  />

  <!-- Booking Introduction -->
  <section class="py-12 bg-white">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto text-center">
        <h2 class="text-3xl font-bold mb-6 text-primary">Book Your Table</h2>
        <p class="text-lg text-gray-700 mb-8">
          Reserve your spot at one of our welcoming pubs. Whether it's a casual dinner, special celebration, 
          or Sunday roast with family, we're ready to welcome you.
        </p>
        
        <!-- Temporary Booking Widget Placeholder -->
        <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-12 mb-12">
          <div class="text-center">
            <Calendar class="w-16 h-16 text-gray-400 mx-auto mb-4" />
            <h3 class="text-2xl font-bold text-gray-600 mb-2">Booking Widget Coming Soon</h3>
            <p class="text-gray-500 mb-6">
              Our integrated booking system will be available here shortly. 
              In the meantime, please contact your preferred pub directly.
            </p>
            <div class="bg-white p-6 rounded-lg shadow-sm max-w-md mx-auto">
              <h4 class="font-semibold mb-3">For immediate bookings:</h4>
              <ul class="text-sm text-gray-600 space-y-1">
                <li>• Call the pub directly</li>
                <li>• Visit in person</li>
                <li>• Check individual pub websites</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Pub Selection -->
  <section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-bold mb-4 text-primary">Choose Your Pub</h2>
        <p class="text-lg text-gray-700">Select from our collection of traditional British pubs</p>
      </div>
      
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
        {pubs.map(pub => {
          const imageUrl = pub.heroImage?.asset?.url || pub.image?.asset?.url || '/images/pub-fallback.jpg';
          const imageAlt = pub.heroImage?.alt || pub.image?.alt || `Image of ${pub.name}`;
          const location = pub.locationName || `${pub.addressLine1}, ${pub.postcode}`.trim();
          
          return (
            <Card key={pub.slug.current} className="overflow-hidden hover:shadow-lg transition-all duration-300">
              <div class="relative aspect-[4/3] overflow-hidden">
                <img
                  src={imageUrl}
                  alt={imageAlt}
                  class="w-full h-full object-cover transition-transform hover:scale-105"
                  loading="lazy"
                  decoding="async"
                  onerror="this.onerror=null; this.src='/images/pub-fallback.jpg';"
                />
              </div>
              <CardHeader>
                <CardTitle className="text-xl">{pub.name}</CardTitle>
                <div class="flex items-center text-sm text-muted-foreground">
                  <MapPin className="w-4 h-4 mr-2" />
                  <span>{location}</span>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                {pub.description && (
                  <CardDescription className="line-clamp-2">
                    {pub.description}
                  </CardDescription>
                )}
                
                <div class="space-y-3">
                  {pub.contactPhone && (
                    <div class="flex items-center text-sm">
                      <Phone className="w-4 h-4 mr-2 text-muted-foreground" />
                      <a href={`tel:${pub.contactPhone}`} class="hover:text-primary transition-colors">
                        {pub.contactPhone}
                      </a>
                    </div>
                  )}
                  
                  {pub.openingHours && (
                    <div class="flex items-center text-sm text-muted-foreground">
                      <Clock className="w-4 h-4 mr-2" />
                      <span>Opening times vary</span>
                    </div>
                  )}
                  
                  {pub.foodServingTimes && (
                    <div class="flex items-center text-sm text-muted-foreground">
                      <Utensils className="w-4 h-4 mr-2" />
                      <span>Food served daily</span>
                    </div>
                  )}
                </div>
                
                <div class="flex gap-2 pt-2">
                  {pub.reservationsUrl ? (
                    <a href={pub.reservationsUrl} target="_blank" rel="noopener noreferrer" class="flex-1">
                      <Button className="w-full bg-primary hover:bg-primary/90">
                        Book Online
                        <ExternalLink className="w-4 h-4 ml-2" />
                      </Button>
                    </a>
                  ) : (
                    <a href={`tel:${pub.contactPhone}`} class="flex-1">
                      <Button className="w-full bg-primary hover:bg-primary/90">
                        Call to Book
                        <Phone className="w-4 h-4 ml-2" />
                      </Button>
                    </a>
                  )}
                </div>
                
                {pub.bookingPolicyText && (
                  <div class="bg-muted/50 p-3 rounded-lg">
                    <p class="text-xs text-muted-foreground">
                      {pub.bookingPolicyText}
                    </p>
                  </div>
                )}
              </CardContent>
            </Card>
          );
        })}
      </div>
    </div>
  </section>

  <!-- Additional Information -->
  <section class="py-12 bg-white">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto text-center">
        <h2 class="text-2xl font-bold mb-6 text-primary">Booking Information</h2>
        <div class="grid md:grid-cols-3 gap-6">
          <div>
            <div class="w-12 h-12 bg-secondary/20 rounded-full flex items-center justify-center mx-auto mb-3">
              <Calendar class="w-6 h-6 text-secondary" />
            </div>
            <h3 class="font-semibold mb-2">Advance Booking</h3>
            <p class="text-sm text-gray-600">
              We recommend booking in advance, especially for weekends and special occasions.
            </p>
          </div>
          
          <div>
            <div class="w-12 h-12 bg-secondary/20 rounded-full flex items-center justify-center mx-auto mb-3">
              <Utensils class="w-6 h-6 text-secondary" />
            </div>
            <h3 class="font-semibold mb-2">Group Bookings</h3>
            <p class="text-sm text-gray-600">
              For parties of 8 or more, please call the pub directly to discuss your requirements.
            </p>
          </div>
          
          <div>
            <div class="w-12 h-12 bg-secondary/20 rounded-full flex items-center justify-center mx-auto mb-3">
              <Clock class="w-6 h-6 text-secondary" />
            </div>
            <h3 class="font-semibold mb-2">Flexible Times</h3>
            <p class="text-sm text-gray-600">
              Most pubs serve food all day, but kitchen hours may vary. Please check when booking.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>